<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>工作台</title>
    <link rel="stylesheet" href="/static/assets/libs/layui/css/layui.css"/>
    <link rel="stylesheet" href="/static/custom/layui_custom.css"/>
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <style>
        html{
            overflow: auto; /* 或者使用 overflow-y: scroll; 来允许垂直滚动 */
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE 和 Edge */
        }

        /* 隐藏Webkit核心浏览器（如Chrome, Safari等）中的滚动条 */
        html::-webkit-scrollbar {
            display: none;
        }
        /** 应用快捷块样式 */
        .cti-upload-box{
            width: 100%;
            margin-top: 10px;
        }
        .cti-upload-box .model-form{
            width: 95%;
        }
        .upload-cti-file-item{
            display: flex;
            align-items: center;
            justify-content: flex-start;
        }
        .upload-cti-file-item input{
            margin-right: 10px;
            
        }
        .upload-cti-file-item button{
            width: 110px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .model-form .model-form-footer{
            width: 100%;
            text-align: center;
            margin-left: 20px;
        }
        .model-form-footer button:first-child{
            background-color: #285191;
        }
        .model-form-footer button:nth-child(2){
            border-color: #285191;
        }
    </style>
</head>
<body>
<!-- 正文开始 -->
<div class="cti-upload-box">
    <form class="layui-form model-form">
        <!-- <div class="layui-form-item">
            <label class="layui-form-label">情报ID：</label>
            <div class="layui-input-block">
                <input name="cti_id" lay-verify="required" placeholder="请输入情报ID" autocomplete="off" class="layui-input" type="text">
            </div>
        </div> -->
        <div class="layui-form-item">
            <label class="layui-form-label">情报名称：</label>
            <div class="layui-input-block">
                <input name="cti_name" lay-verify="required" placeholder="请输入CTI名称" autocomplete="off" class="layui-input" type="text">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">标签：</label>
            <div class="layui-input-block">
                <input name="tags" placeholder="请输入标签" autocomplete="off" class="layui-input" type="text">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">开源形式：</label>
            <div class="layui-input-block">
                <select name="open_source" lay-verify="required" lay-filter="open_source">
                    <option value="0">不开源</option>
                    <option value="1">开源</option>
                    <option value="2">部分开源</option>
                </select>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">类型：</label>
            <div class="layui-input-block">
                <select name="type" lay-verify="required" lay-filter="type">
                    <option value="1">钓鱼地址</option>
                    <option value="2">恶意程序</option>
                    <option value="3">放马地址</option>
                    <option value="4">恶意邮箱</option>
                    <option value="5">恶意手机号</option>
                    <option value="6">僵尸网络</option>
                    <option value="7">社交账号</option>
                    <option value="8">DDoS数据</option>
                    <option value="9">开源情报</option>
                </select>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">威胁等级：</label>
            <div class="layui-input-block">
                <input name="threat_level" lay-verify="required" placeholder="请输入威胁等级" autocomplete="off" class="layui-input" type="number">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">数据：</label>
            <div class="layui-input-block">
                <textarea name="data" placeholder="请输入数据" class="layui-textarea"></textarea>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">数据大小：</label>
            <div class="layui-input-block">
                <input name="data_size" lay-verify="required" placeholder="请输入数据大小(B)" autocomplete="off" class="layui-input" type="number">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">加密密钥：</label>
            <div class="layui-input-block">
                <input name="cryto_pwd"  placeholder="输入加密密钥" autocomplete="off" class="layui-input" type="text">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">下载地址：</label>
            <div class="layui-input-block upload-cti-file-item">
                <input  id="download_url" name="download_url"  placeholder="请输入下载地址" autocomplete="off" class="layui-input" type="text">
                <button type="button" class="layui-btn" id="upload_cti_file" style="background-color: #125fab;">
                    <i class="layui-icon"></i>上传文件
                </button>
            </div>
            
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">数据描述：</label>
            <div class="layui-input-block">
                <textarea name="description" placeholder="请输入数据描述" class="layui-textarea"></textarea>
            </div>
        </div>
        <div class="layui-form-item text-center model-form-footer">
            <button class="layui-btn" lay-filter="submitCtiUploadForm" lay-submit>上传</button>
            <button class="layui-btn layui-btn-primary" type="button" onclick="closeParentLayer()">关闭</button>
        </div>
    </form>
</div>
<!-- js部分 -->
<script type="text/javascript" src="/static/assets/libs/layui/layui.js"></script>
<script>
function getWindowLayerIndex(){
    var layerIndex = parent.layer.getFrameIndex(window.name); 
    return layerIndex;
}
function closeParentLayer(){
    var index = parent.layer.getFrameIndex(window.name); // 先得到当前 iframe 层的索引
    parent.layer.close(index); // 再执行关闭
}
layui.use(['form','upload'], function(){
    var form = layui.form
            ,upload = layui.upload
            ,$ = layui.$;
    // 开源形式选择框初始化
    form.on('select(open_source)', function(data) {
        console.log(data.value); // 得到被选中的值
    });

    form.on('submit(submitCtiUploadForm)', function (data) {
            // 在发送数据之前，进行数据格式转换
            data.field.type = parseInt(data.field.type, 10);
            data.field.data_size = parseInt(data.field.data_size, 10);
            data.field.open_source = parseInt(data.field.open_source, 10);
            data.field.threat_level = parseInt(data.field.threat_level, 10);

            // 网络请求
            var loadIndex = layer.load(2);
            console.log(data.field)
            $.ajax({
                type: "POST",
                url: '/cti-market/upload',
                data: JSON.stringify(data.field),
                contentType: "application/json",
                dataType: "json",
                success: function (res) {
                    console.log(res)
                    layer.close(loadIndex);
                    if (res.code == 0) {
                        // 提示语
                        layer.msg('上传成功', {
                            icon: 1,
                            time: 800
                        });
                        // setTimeout(() => {
                        //     closeParentLayer()
                        // }, 1000);
                    } else {
                        // 错误信息
                        layer.msg(res.msg, {icon: 2, anim: 6});
                    }
                    
                    return false;
                },
                error: function () {
                    layer.msg("AJAX请求异常");
                }
            });
        return false;
    });
    // 网络请求
    var loadIndex = null
    //上传CTI文件
    var uploadInst = upload.render({
        elem: '#upload_cti_file'
        ,url: "/cti-market/uploadCtiFile"
        ,accept:'file'
        ,field:'file'//文件域字段名
        ,size: 10240*500 //最大允许上传的文件大小
        ,before: function(obj){
            //预读本地文件
            loadIndex = layer.load(20);
        }
        ,done: function(res){
            //上传完毕回调
            layer.close(loadIndex);
            console.log(res)
            if(res.code != 0){
                layer.msg(res.msg,{ icon: 5 });
                return false;
            }

            //上传成功
            layer.msg('上传成功');
            $('#download_url').val(res.data.src);
        }
        ,error: function(){
            //请求异常回调
            layer.close(loadIndex);
            return layer.msg('数据请求异常');
        }
    });
});


</script>
</body>
</html>
